{
  "version": 3,
  "sources": ["../../server/config-loader.ts"],
  "sourcesContent": ["/**\n * Config loader\n * Pokemon Showdown - http://pokemonshowdown.com/\n *\n * @license MIT\n */\n\nimport * as defaults from '../config/config-example';\nimport type { GroupInfo, EffectiveGroupSymbol } from './user-groups';\nimport { ProcessManager, FS } from '../lib';\n\ntype DefaultConfig = typeof defaults;\n\ntype InputConfig = Omit<DefaultConfig, 'subprocesses'> & {\n\tsubprocesses: null | 0 | 1 | SubProcessesConfig,\n};\n\ntype ProcessType = (\n\t'localartemis' | 'remoteartemis' | 'battlesearch' | 'datasearch' | 'friends' |\n\t'chatdb' | 'pm' | 'modlog' | 'network' | 'simulator' | 'validator' | 'verifier'\n);\n\ntype SubProcessesConfig = Partial<Record<ProcessType, number>>;\n\nexport type ConfigType = InputConfig & {\n\tgroups: { [symbol: string]: GroupInfo },\n\tgroupsranking: EffectiveGroupSymbol[],\n\tgreatergroupscache: { [combo: string]: GroupSymbol },\n\tsubprocessescache: SubProcessesConfig,\n\t[k: string]: any,\n};\n/** Map<process flag, config settings for it to turn on> */\nconst FLAG_PRESETS = new Map([\n\t['--no-security', ['nothrottle', 'noguestsecurity', 'noipchecks']],\n]);\n\nconst processTypes: ProcessType[] = [\n\t'localartemis', 'remoteartemis', 'battlesearch', 'datasearch', 'friends',\n\t'chatdb', 'pm', 'modlog', 'network', 'simulator', 'validator', 'verifier',\n];\n\nconst CONFIG_PATH = FS('./config/config.js').path;\n\nexport function load(invalidate = false) {\n\tif (invalidate) delete require.cache[CONFIG_PATH];\n\tconst config = ({ ...defaults, ...require(CONFIG_PATH) }) as ConfigType;\n\t// config.routes is nested - we need to ensure values are set for its keys as well.\n\tconfig.routes = { ...defaults.routes, ...config.routes };\n\n\tif (!process.send) {\n\t\t// Automatically stop startup if optional dependencies are enabled yet missing\n\t\tif (config.usesqlite) {\n\t\t\ttry {\n\t\t\t\trequire.resolve('better-sqlite3');\n\t\t\t} catch {\n\t\t\t\tthrow new Error(`better-sqlite3 is not installed or could not be loaded, but Config.usesqlite is enabled.`);\n\t\t\t}\n\t\t}\n\n\t\tif (config.ofemain) {\n\t\t\ttry {\n\t\t\t\trequire.resolve('node-oom-heapdump');\n\t\t\t} catch {\n\t\t\t\tthrow new Error(\n\t\t\t\t\t`node-oom-heapdump is not installed, but it is a required dependency if Config.ofemain is set to true! ` +\n\t\t\t\t\t`Run npm install node-oom-heapdump and restart the server.`\n\t\t\t\t);\n\t\t\t}\n\t\t}\n\t}\n\n\tfor (const [preset, values] of FLAG_PRESETS) {\n\t\tif (process.argv.includes(preset)) {\n\t\t\tfor (const value of values) config[value] = true;\n\t\t}\n\t}\n\n\tcacheSubProcesses(config);\n\tcacheGroupData(config);\n\treturn config;\n}\n\nfunction cacheSubProcesses(config: ConfigType) {\n\tif (config.subprocesses !== undefined) {\n\t\t// Leniently accept all other falsy values, including `null`.\n\t\tconst value = config.subprocesses || 0;\n\t\tif (value === 0 || value === 1) {\n\t\t\t// https://github.com/microsoft/TypeScript/issues/35745\n\t\t\tconfig.subprocessescache = (Object.fromEntries(\n\t\t\t\tprocessTypes.map(k => [k, value])\n\t\t\t) as Record<ProcessType, number>);\n\t\t} else if (typeof value === 'object') {\n\t\t\tconfig.subprocessescache = value;\n\t\t} else {\n\t\t\treportError(`Invalid \\`subprocesses\\` specification. Use any of 0, 1, or a plain old object.`);\n\t\t}\n\t}\n\tconfig.subprocessescache ??= {};\n\tconst deprecatedKeys = [];\n\tif ('workers' in config) {\n\t\tdeprecatedKeys.push('workers');\n\t\tconfig.subprocessescache.network = config.workers;\n\t}\n\tfor (const processType of processTypes) {\n\t\tif (processType === 'network') continue;\n\t\tconst compatKey = `${processType}processes`;\n\t\tif (compatKey in config) {\n\t\t\tdeprecatedKeys.push(compatKey);\n\t\t\tconfig.subprocessescache[processType] = config[compatKey];\n\t\t}\n\t}\n\tfor (const compatKey of deprecatedKeys) {\n\t\treportError(\n\t\t\t`You are using \\`${compatKey}\\`, which is deprecated\\n` +\n\t\t\t`Support for this may be removed.\\n` +\n\t\t\t`Please ensure that you update your config.js to use \\`subprocesses\\` (see config-example.js, line 80).\\n`\n\t\t);\n\t}\n}\n\nexport function cacheGroupData(config: ConfigType) {\n\tif (config.groups) {\n\t\t// Support for old config groups format.\n\t\t// Should be removed soon.\n\t\treportError(\n\t\t\t`You are using a deprecated version of user group specification in config.\\n` +\n\t\t\t`Support for this may be removed.\\n` +\n\t\t\t`Please ensure that you update your config.js to the new format (see config-example.js, line 521).\\n`\n\t\t);\n\t} else {\n\t\tconfig.punishgroups = Object.create(null);\n\t\tconfig.groups = Object.create(null);\n\t\tconfig.groupsranking = [];\n\t\tconfig.greatergroupscache = Object.create(null);\n\t}\n\n\tconst groups = config.groups;\n\tconst punishgroups = config.punishgroups;\n\tconst cachedGroups: { [k: string]: 'processing' | true } = {};\n\n\tfunction isPermission(key: string) {\n\t\treturn !['symbol', 'id', 'name', 'rank', 'globalGroupInPersonalRoom'].includes(key);\n\t}\n\tfunction cacheGroup(symbol: string, groupData: GroupInfo) {\n\t\tif (cachedGroups[symbol] === 'processing') {\n\t\t\tthrow new Error(`Cyclic inheritance in group config for symbol \"${symbol}\"`);\n\t\t}\n\t\tif (cachedGroups[symbol] === true) return;\n\n\t\tfor (const key in groupData) {\n\t\t\tif (isPermission(key)) {\n\t\t\t\tconst jurisdiction = groupData[key as 'jurisdiction'];\n\t\t\t\tif (typeof jurisdiction === 'string' && jurisdiction.includes('s')) {\n\t\t\t\t\treportError(`Outdated jurisdiction for permission \"${key}\" of group \"${symbol}\": 's' is no longer a supported jurisdiction; we now use 'ipself' and 'altsself'`);\n\t\t\t\t\tdelete groupData[key as 'jurisdiction'];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (groupData['inherit']) {\n\t\t\tcachedGroups[symbol] = 'processing';\n\t\t\tconst inheritGroup = groups[groupData['inherit']];\n\t\t\tcacheGroup(groupData['inherit'], inheritGroup);\n\t\t\t// Add lower group permissions to higher ranked groups,\n\t\t\t// preserving permissions specifically declared for the higher group.\n\t\t\tfor (const key in inheritGroup) {\n\t\t\t\tif (key in groupData) continue;\n\t\t\t\tif (!isPermission(key)) continue;\n\t\t\t\t(groupData as any)[key] = (inheritGroup as any)[key];\n\t\t\t}\n\t\t\tdelete groupData['inherit'];\n\t\t}\n\t\tcachedGroups[symbol] = true;\n\t}\n\n\tif (config.grouplist) { // Using new groups format.\n\t\tconst grouplist = config.grouplist as any;\n\t\tconst numGroups = grouplist.length;\n\t\tfor (let i = 0; i < numGroups; i++) {\n\t\t\tconst groupData = grouplist[i];\n\n\t\t\t// punish groups\n\t\t\tif (groupData.punishgroup) {\n\t\t\t\tpunishgroups[groupData.id] = groupData;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tgroupData.rank = numGroups - i - 1;\n\t\t\tgroups[groupData.symbol] = groupData;\n\t\t\tconfig.groupsranking.unshift(groupData.symbol);\n\t\t}\n\t}\n\n\tfor (const sym in groups) {\n\t\tconst groupData = groups[sym];\n\t\tcacheGroup(sym, groupData);\n\t}\n\n\t// hardcode default punishgroups.\n\tif (!punishgroups.locked) {\n\t\tpunishgroups.locked = {\n\t\t\tname: 'Locked',\n\t\t\tid: 'locked',\n\t\t\tsymbol: '\\u203d',\n\t\t};\n\t}\n\tif (!punishgroups.muted) {\n\t\tpunishgroups.muted = {\n\t\t\tname: 'Muted',\n\t\t\tid: 'muted',\n\t\t\tsymbol: '!',\n\t\t};\n\t}\n}\n\nexport function checkRipgrepAvailability() {\n\tif (Config.ripgrepmodlog === undefined) {\n\t\tconst cwd = FS.ROOT_PATH;\n\t\tConfig.ripgrepmodlog = (async () => {\n\t\t\ttry {\n\t\t\t\tawait ProcessManager.exec(['rg', '--version'], { cwd });\n\t\t\t\tawait ProcessManager.exec(['tac', '--version'], { cwd });\n\t\t\t\treturn true;\n\t\t\t} catch {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t})();\n\t}\n\treturn Config.ripgrepmodlog;\n}\n\nfunction reportError(msg: string) {\n\t// This module generally loads before Monitor, so we put this in a setImmediate to wait for it to load.\n\t// Most child processes don't have Monitor.error, but the main process should always have them, and Config\n\t// errors should always be the same across processes, so this is a neat way to avoid unnecessary logging.\n\tsetImmediate(() => global.Monitor?.error?.(`[CONFIG] ${msg}`));\n}\nexport const Config = load();\n"],
  "mappings": "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",
  "names": []
}
